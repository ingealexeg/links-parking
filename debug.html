<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>TAS | Debug & Local Bridge</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Montserrat', sans-serif; background: #f4f4f4; padding: 20px; display: flex; justify-content: center; }
        .debug-card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 500px; width: 100%; }
        h2 { color: #e31e24; margin-top: 0; }
        .status { padding: 10px; border-radius: 5px; margin-bottom: 15px; font-weight: bold; }
        .status.waiting { background: #fff3cd; color: #856404; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .data-box { background: #231f20; color: #00ff00; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 0.9rem; overflow-x: auto; }
        .config-info { font-size: 0.8rem; color: #666; margin-top: 20px; border-top: 1px solid #eee; pt: 10px; }
    </style>
</head>
<body>

    <div class="debug-card">
        <h2>Bridge de Diagnóstico</h2>
        <div id="connectionStatus" class="status waiting">Iniciando conexión local...</div>
        
        <p><strong>Respuesta del Servidor Janus:</strong></p>
        <div id="rawResponse" class="data-box">Esperando datos...</div>

        <div class="config-info">
            <strong>Configuración Actual:</strong><br>
            IP Objetivo: <span id="targetIpDisplay"></span><br>
            Endpoint: <code>/api/v1/installation/3569036549/ticket/cost</code>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURACIÓN ESCALABLE
        // ==========================================
        // Cuando IT te de la IP pública, solo cambias esta línea:
        const JANUS_SERVER_IP = "10.10.5.15"; 
        // ==========================================

        const params = new URLSearchParams(window.location.search);
        const ticket = params.get('ticket') || "WvHFg6cChjWYBzgVqXYfWdfjxbcXYMpM";

        document.getElementById('targetIpDisplay').innerText = JANUS_SERVER_IP;

        async function testLocalConnection() {
            const statusDiv = document.getElementById('connectionStatus');
            const responseDiv = document.getElementById('rawResponse');

            // Construimos la URL apuntando directamente al servidor local
            // Nota: Se asume puerto 80 o el que Janus use por defecto
            const localUrl = `http://${JANUS_SERVER_IP}/api/v1/installation/3569036549/ticket/${ticket}/cost`;

            try {
                // Petición directa (Sin proxies, ya que estamos en la misma red)
                const response = await fetch(localUrl, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });

                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);

                const data = await response.json();

                statusDiv.className = "status success";
                statusDiv.innerText = "¡Conexión Exitosa!";
                responseDiv.innerText = JSON.stringify(data, null, 4);

                console.log("Datos recibidos:", data);

            } catch (err) {
                statusDiv.className = "status error";
                statusDiv.innerText = "Error de Conexión Local";
                responseDiv.innerText = `Causa: ${err.message}\n\nPosibles razones:\n1. No estás en la misma red que el servidor.\n2. El servidor no tiene habilitado CORS.\n3. La IP ${JANUS_SERVER_IP} es incorrecta.`;
            }
        }

        // Ejecutar prueba
        testLocalConnection();
    </script>
</body>
</html>
