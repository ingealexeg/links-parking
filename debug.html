<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>TAS Bridge | Postman Mirror Final</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f0f0f; color: #00ff41; display: flex; justify-content: center; padding: 20px; }
        .container { background: #1a1a1a; width: 100%; max-width: 650px; padding: 25px; border-radius: 10px; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .status-bar { padding: 15px; margin-bottom: 20px; border-radius: 5px; text-align: center; font-weight: bold; font-size: 1.1rem; }
        .waiting { background: #332b00; color: #ffcc00; border: 1px solid #665500; }
        .success { background: #1b3321; color: #44ff44; border: 1px solid #2b5c35; }
        .error { background: #331b1b; color: #ff4444; border: 1px solid #5c2b2b; }
        pre { background: #000; padding: 15px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; font-size: 12px; border: 1px solid #222; }
        .label { color: #888; font-size: 0.8rem; margin-bottom: 5px; display: block; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="color: #fff; margin-top: 0; border-bottom: 2px solid #e31e24; padding-bottom: 10px;">Bridge Final Debug</h2>
    
    <div id="statusBox" class="status-bar waiting">CONECTANDO CON JANUS...</div>

    <span class="label">TICKET ENVIADO:</span>
    <pre id="ticketSent">Cargando...</pre>

    <span class="label">RESPUESTA DEL SERVIDOR:</span>
    <pre id="rawResponse">Esperando respuesta...</pre>
</div>

<script>
    const SERVER_URL = "http://10.10.5.15:8080/janus-integration/api/ext";
    const ticketParams = new URLSearchParams(window.location.search);
    const TICKET_ID = ticketParams.get('ticket');

    async function ejecutarFlujoPostman() {
        const statusBox = document.getElementById('statusBox');
        const rawLog = document.getElementById('rawResponse');
        const ticketLog = document.getElementById('ticketSent');

        if (!TICKET_ID) {
            statusBox.innerText = "ERROR: NO HAY TICKET EN LA URL";
            statusBox.className = "status-bar error";
            return;
        }

        ticketLog.innerText = TICKET_ID;

        try {
            // 1. LOGIN PARA OBTENER TOKEN FRESCO
            const loginRes = await fetch(`${SERVER_URL}/login`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ "username": "TasGT25", "password": "Hub$2025" })
            });
            const loginXml = await loginRes.text();
            const token = loginXml.match(/<value>(.*?)<\/value>/)[1];

            // 2. CONSULTA (CÓDIGO POSTMAN EXACTO)
            const myHeaders = new Headers();
            myHeaders.append("Janus-TP-Authorization", token);
            myHeaders.append("Content-Type", "application/json");

            const rawBody = JSON.stringify({
                "mediaTypeIdentifier": "barcode",
                "ticketIdentifier": TICKET_ID.trim()
            });

            const requestOptions = {
                method: "POST",
                headers: myHeaders,
                body: rawBody,
                redirect: "follow"
            };

            const response = await fetch(`${SERVER_URL}/payment/get/ticketdata`, requestOptions);
            const result = await response.text();
            
            // MOSTRAR RESULTADO
            rawLog.innerText = result;

            if (result.includes("<status>ok</status>") || result.includes("<status>OK</status>")) {
                const monto = result.match(/<amountToPay>(.*?)<\/amountToPay>/)[1];
                statusBox.innerText = `ÉXITO: Q${monto} A COBRAR`;
                statusBox.className = "status-bar success";
            } else {
                statusBox.innerText = "ERROR EN RESPUESTA DE JANUS";
                statusBox.className = "status-bar error";
            }

        } catch (error) {
            statusBox.innerText = "FALLO CRÍTICO DE CONEXIÓN";
            statusBox.className = "status-bar error";
            rawLog.innerText = error;
        }
    }

    window.onload = ejecutarFlujoPostman;
</script>

</body>
</html>
